{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}
{% block page_title %}Admin Dashboard{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card indigo fade-up stagger-1">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-value">{{ total_clients }}</div>
        <div class="stat-label">Total Clients</div>
    </div>
    <div class="stat-card cyan fade-up stagger-2">
        <div class="stat-icon">ğŸ“¦</div>
        <div class="stat-value">{{ total_products }}</div>
        <div class="stat-label">Total Products</div>
    </div>
    <div class="stat-card violet fade-up stagger-3">
        <div class="stat-icon">ğŸ“‹</div>
        <div class="stat-value">{{ total_complaints }}</div>
        <div class="stat-label">Total Complaints</div>
    </div>
    <div class="stat-card emerald fade-up stagger-4">
        <div class="stat-icon">ğŸ“…</div>
        <div class="stat-value">{{ complaints_today }}</div>
        <div class="stat-label">Today</div>
    </div>
    <div class="stat-card amber fade-up stagger-5">
        <div class="stat-icon">ğŸ“†</div>
        <div class="stat-value">{{ complaints_week }}</div>
        <div class="stat-label">This Week</div>
    </div>
    <div class="stat-card rose fade-up stagger-6">
        <div class="stat-icon">ğŸ—“ï¸</div>
        <div class="stat-value">{{ complaints_month }}</div>
        <div class="stat-label">This Month</div>
    </div>
</div>

<!-- Charts Row -->
<div class="charts-grid">
    <div class="glass-card fade-up">
        <div class="card-header">
            <h3>Complaint Status</h3>
        </div>
        <div class="chart-container">
            <canvas id="statusChart" height="260"></canvas>
        </div>
    </div>
    <div class="glass-card fade-up">
        <div class="card-header">
            <h3>Priority Distribution</h3>
        </div>
        <div class="chart-container">
            <canvas id="priorityChart" height="260"></canvas>
        </div>
    </div>
</div>

<!-- Top Faults -->
<div class="glass-card fade-up mb-3">
    <div class="card-header">
        <h3>Top Faults</h3>
    </div>
    <div class="chart-container">
        <canvas id="faultChart" height="200"></canvas>
    </div>
</div>

<!-- Recent Complaints -->
<div class="glass-card fade-up">
    <div class="card-header">
        <h3>Recent Complaints</h3>
        <a href="{% url 'complaint_list' %}" class="btn btn-secondary btn-sm">View All â†’</a>
    </div>
    {% if recent_complaints %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Complaint #</th>
                    <th>Client</th>
                    <th>Product</th>
                    <th>Fault</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for c in recent_complaints %}
                <tr>
                    <td class="td-bold">{{ c.complaint_no }}</td>
                    <td>{{ c.client }}</td>
                    <td>{{ c.product }}</td>
                    <td>{{ c.fault|default:"â€”" }}</td>
                    <td><span class="badge badge-{{ c.status }}">{{ c.get_status_display }}</span></td>
                    <td><span class="badge badge-{{ c.priority }}">{{ c.get_priority_display }}</span></td>
                    <td>{{ c.created_at|date:"d M Y" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ“‹</div>
        <p>No complaints yet</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Status Doughnut
    const statusData = JSON.parse('{{ status_data|escapejs }}');
    const sLabels = statusData.map(d => d.status);
    const sValues = statusData.map(d => d.count);
    const sColors = sLabels.map(s => ({
        'new': '#818cf8', 'assigned': '#fbbf24', 'in_progress': '#22d3ee',
        'resolved': '#34d399', 'closed': '#9ca3af', 'visit_only': '#a78bfa', 'cancel': '#fb7185'
    }[s] || '#6b7280'));

    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: { labels: sLabels, datasets: [{ data: sValues, backgroundColor: sColors, borderWidth: 0 }] },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#9a9ab8', padding: 14, usePointStyle: true, pointStyleWidth: 10 } }
            },
            cutout: '65%'
        }
    });

    // Priority Bar
    const priorityData = JSON.parse('{{ priority_data|escapejs }}');
    const pLabels = priorityData.map(d => d.priority);
    const pValues = priorityData.map(d => d.count);
    const pColors = pLabels.map(p => ({ 'high': '#fb7185', 'medium': '#fbbf24', 'low': '#34d399' }[p] || '#6b7280'));

    new Chart(document.getElementById('priorityChart'), {
        type: 'bar',
        data: { labels: pLabels, datasets: [{ data: pValues, backgroundColor: pColors, borderRadius: 6, barThickness: 36 }] },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#9a9ab8' }, grid: { display: false } },
                y: { ticks: { color: '#9a9ab8' }, grid: { color: 'rgba(255,255,255,0.04)' } }
            }
        }
    });

    // Top Faults
    const faultData = JSON.parse('{{ fault_data|escapejs }}');
    const fLabels = faultData.map(d => d.fault);
    const fValues = faultData.map(d => d.count);

    new Chart(document.getElementById('faultChart'), {
        type: 'bar',
        data: {
            labels: fLabels,
            datasets: [{
                data: fValues,
                backgroundColor: ['#818cf8', '#22d3ee', '#a78bfa', '#fbbf24', '#34d399'],
                borderRadius: 6,
                barThickness: 36
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#9a9ab8' }, grid: { color: 'rgba(255,255,255,0.04)' } },
                y: { ticks: { color: '#9a9ab8' }, grid: { display: false } }
            }
        }
    });
</script>
{% endblock %}