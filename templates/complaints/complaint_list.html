{% extends 'base.html' %}

{% block title %}Complaints{% endblock %}
{% block page_title %}All Complaints{% endblock %}

{% block content %}
<div class="section-header">
    <h2 class="section-title">Complaint Register</h2>
    {% if user.role == 'admin' or user.role == 'operations' %}
    <a href="{% url 'create_complaint' %}" class="btn btn-primary">+ New Complaint</a>
    {% endif %}
</div>

<!-- Search & Filter Bar -->
<div class="glass-card fade-up mb-3" style="padding:16px 20px;">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
        <div style="flex:1;min-width:200px;">
            <input type="text" id="search-input" class="form-control"
                placeholder="ðŸ” Search by complaint #, client, product, fault..." style="width:100%;">
        </div>
        <div>
            <select id="filter-status" class="form-control" style="min-width:140px;">
                <option value="">All Status</option>
                <option value="new">New</option>
                <option value="assigned">Assigned</option>
                <option value="in_progress">In Progress</option>
                <option value="resolved">Resolved</option>
                <option value="closed">Closed</option>
                <option value="visit_only">Visit Only</option>
                <option value="cancel">Cancelled</option>
            </select>
        </div>
        <div>
            <select id="filter-priority" class="form-control" style="min-width:120px;">
                <option value="">All Priority</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
        </div>
        <div>
            <span id="results-count" style="font-size:12px;color:var(--text-muted);"></span>
        </div>
    </div>
</div>

<!-- Complaints Table -->
<div class="glass-card fade-up">
    {% if complaints %}
    <div class="table-container">
        <table class="data-table" id="complaints-table">
            <thead>
                <tr>
                    <th>Complaint #</th>
                    <th>Client</th>
                    <th>Product</th>
                    <th>Fault</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Service â‚¹</th>
                    <th>Parts â‚¹</th>
                    <th>Total â‚¹</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="complaints-body">
                {% for c in complaints %}
                <tr data-status="{{ c.status }}" data-priority="{{ c.priority }}"
                    data-search="{{ c.complaint_no|lower }} {{ c.client|lower }} {{ c.product|lower }} {{ c.fault|default:'â€”'|lower }}">
                    <td class="td-bold">{{ c.complaint_no }}</td>
                    <td>{{ c.client }}</td>
                    <td>{{ c.product }}</td>
                    <td>{{ c.fault|default:"â€”" }}</td>
                    <td><span class="badge badge-{{ c.status }}">{{ c.get_status_display }}</span></td>
                    <td><span class="badge badge-{{ c.priority }}">{{ c.get_priority_display }}</span></td>
                    <td style="text-align:right;">{{ c.service_charge|default:"0" }}</td>
                    <td style="text-align:right;">{{ c.total_parts_cost|default:"0" }}</td>
                    <td style="text-align:right;font-weight:700;color:var(--accent-emerald);">{{
                        c.grand_total|default:"0" }}</td>
                    <td>{{ c.created_at|date:"d M Y" }}</td>
                    <td>
                        {% if c.status == 'new' %}
                        <a href="{% url 'assign_complaint' c.pk %}" class="btn btn-primary btn-sm">Assign</a>
                        {% elif c.status == 'resolved' or c.status == 'closed' %}
                        <span class="badge badge-{{ c.status }}">{{ c.get_status_display }}</span>
                        {% else %}
                        <span class="badge badge-{{ c.status }}">{{ c.get_status_display }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ðŸ“‹</div>
        <p>No complaints found</p>
        {% if user.role == 'admin' or user.role == 'operations' %}
        <a href="{% url 'create_complaint' %}" class="btn btn-primary" style="margin-top:12px;">+ Create First
            Complaint</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('filter-status');
        const priorityFilter = document.getElementById('filter-priority');
        const rows = document.querySelectorAll('#complaints-body tr');
        const countEl = document.getElementById('results-count');

        function filterTable() {
            const query = searchInput.value.toLowerCase().trim();
            const statusVal = statusFilter.value;
            const priorityVal = priorityFilter.value;
            let visible = 0;

            rows.forEach(row => {
                const searchData = row.dataset.search || '';
                const rowStatus = row.dataset.status || '';
                const rowPriority = row.dataset.priority || '';

                const matchesSearch = !query || searchData.includes(query);
                const matchesStatus = !statusVal || rowStatus === statusVal;
                const matchesPriority = !priorityVal || rowPriority === priorityVal;

                if (matchesSearch && matchesStatus && matchesPriority) {
                    row.style.display = '';
                    visible++;
                } else {
                    row.style.display = 'none';
                }
            });

            countEl.textContent = `${visible} of ${rows.length} complaints`;
        }

        searchInput.addEventListener('input', filterTable);
        statusFilter.addEventListener('change', filterTable);
        priorityFilter.addEventListener('change', filterTable);

        filterTable();
    });
</script>
{% endblock %}