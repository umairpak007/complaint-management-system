{% extends 'base.html' %}

{% block title %}Complaint Detail{% endblock %}
{% block page_title %}Complaint Detail{% endblock %}

{% block content %}
<!-- Complaint Overview -->
<div class="glass-card fade-up mb-3">
    <div class="card-header">
        <h3>{{ complaint.complaint_no }}</h3>
        <div class="btn-group">
            <span class="badge badge-{{ complaint.status }}">{{ complaint.get_status_display }}</span>
            <span class="badge badge-{{ complaint.priority }}">{{ complaint.get_priority_display }}</span>
        </div>
    </div>

    <div class="detail-grid">
        <div>
            <div class="detail-row">
                <span class="detail-label">Client</span>
                <span class="detail-value">{{ complaint.client }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Product</span>
                <span class="detail-value">{{ complaint.product }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Fault</span>
                <span class="detail-value">{{ complaint.fault|default:"â€”" }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Created</span>
                <span class="detail-value">{{ complaint.created_at|date:"d M Y, h:i A" }}</span>
            </div>
        </div>
        <div>
            {% if complaint.is_warranty %}
            <div class="detail-row">
                <span class="detail-label">Coverage</span>
                <span class="detail-value"><span class="badge badge-assigned">ğŸ›¡ï¸ Warranty</span></span>
            </div>
            {% elif complaint.is_amc %}
            <div class="detail-row">
                <span class="detail-label">Coverage</span>
                <span class="detail-value"><span class="badge badge-in_progress">ğŸ“‹ AMC</span></span>
            </div>
            {% elif complaint.is_free %}
            <div class="detail-row">
                <span class="detail-label">Coverage</span>
                <span class="detail-value"><span class="badge badge-resolved">ğŸ†“ Free</span></span>
            </div>
            {% endif %}
            <div class="detail-row">
                <span class="detail-label">Service Charge</span>
                <span class="detail-value">â‚¹{{ complaint.service_charge|default:"0.00" }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Parts Cost</span>
                <span class="detail-value">â‚¹{{ complaint.total_parts_cost|default:"0.00" }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Grand Total</span>
                <span class="detail-value" style="font-weight:800;color:var(--accent-emerald);font-size:18px;">â‚¹{{
                    complaint.grand_total|default:"0.00" }}</span>
            </div>
        </div>
    </div>

    {% if complaint.other_details %}
    <div style="margin-top:16px;">
        <span class="detail-label">Other Details</span>
        <p style="margin-top:6px;color:var(--text-secondary);font-size:13.5px;">{{ complaint.other_details }}</p>
    </div>
    {% endif %}

    {% if complaint.resolution_remarks %}
    <div
        style="margin-top:16px;padding:14px;border-radius:8px;background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.15);">
        <span class="detail-label" style="color:var(--accent-emerald);">âœ… Resolution Remarks</span>
        <p style="margin-top:6px;color:var(--text-secondary);font-size:13.5px;">{{ complaint.resolution_remarks }}</p>
        {% if complaint.resolved_at %}
        <small style="color:var(--text-muted);">Resolved: {{ complaint.resolved_at|date:"d M Y, h:i A" }}</small>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Issued Parts -->
{% if issued_parts %}
<div class="glass-card fade-up mb-3">
    <div class="card-header">
        <h3>ğŸ”§ Issued Parts</h3>
    </div>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Part</th>
                    <th>Source</th>
                    <th>Qty Issued</th>
                    <th>Qty Used</th>
                    <th>Status</th>
                    <th>Cost/Unit</th>
                    <th>Total Cost</th>
                </tr>
            </thead>
            <tbody>
                {% for pi in issued_parts %}
                <tr>
                    <td class="td-bold">{{ pi.part.name }} <small style="color:var(--text-muted);">({{ pi.part.make
                            }})</small></td>
                    <td>{{ pi.get_source_display }}</td>
                    <td style="text-align:center;">{{ pi.quantity }}</td>
                    <td style="text-align:center;">{{ pi.used_quantity }}</td>
                    <td><span class="badge badge-{{ pi.usage_status }}">{{ pi.get_usage_status_display }}</span></td>
                    <td style="text-align:right;">â‚¹{{ pi.part_cost_at_time }}</td>
                    <td style="text-align:right;font-weight:700;color:var(--accent-cyan);">â‚¹{{ pi.calculate_cost }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Actions -->
{% if complaint.status == 'assigned' %}
<div class="btn-group fade-up">
    <a href="{% url 'resolve_complaint' complaint.pk %}" class="btn btn-success btn-lg">âœ“ Resolve Complaint</a>
    <a href="{% url 'update_complaint_status' complaint.pk %}" class="btn btn-warning">âš¡ Update Status</a>
</div>
{% endif %}
{% endblock %}