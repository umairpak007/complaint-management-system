{% extends 'base.html' %}

{% block title %}Resolve Complaint{% endblock %}
{% block page_title %}Resolve Complaint{% endblock %}

{% block content %}
<!-- Complaint Info -->
<div class="glass-card fade-up mb-3">
    <div class="card-header">
        <h3>{{ complaint.complaint_no }}</h3>
        <div class="btn-group">
            <span class="badge badge-{{ complaint.status }}">{{ complaint.get_status_display }}</span>
            <span class="badge badge-{{ complaint.priority }}">{{ complaint.get_priority_display }}</span>
        </div>
    </div>
    <div class="detail-grid">
        <div>
            <div class="detail-row">
                <span class="detail-label">Client</span>
                <span class="detail-value">{{ complaint.client }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Product</span>
                <span class="detail-value">{{ complaint.product }}</span>
            </div>
        </div>
        <div>
            <div class="detail-row">
                <span class="detail-label">Fault</span>
                <span class="detail-value">{{ complaint.fault|default:"‚Äî" }}</span>
            </div>
            {% if complaint.other_details %}
            <div class="detail-row">
                <span class="detail-label">Details</span>
                <span class="detail-value">{{ complaint.other_details|truncatewords:20 }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Resolution Form -->
<div class="glass-card fade-up">
    <div class="card-header">
        <h3>üìã Resolution Details</h3>
    </div>
    <form method="post" action="{% url 'resolve_complaint' complaint.pk %}" id="resolve-form">
        {% csrf_token %}

        <!-- Parts Usage Section -->
        {% if issued_parts %}
        <div class="section-header mb-2">
            <h3 class="section-title">üîß Parts Usage & Returns</h3>
        </div>
        <div class="table-container mb-3">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Part Name</th>
                        <th>Source</th>
                        <th>Issued Qty</th>
                        <th>Used Qty</th>
                        <th>Remaining</th>
                        <th>Price/Unit (‚Çπ)</th>
                        <th>Line Total (‚Çπ)</th>
                        <th>Return?</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pi in issued_parts %}
                    <tr class="part-row" data-issued="{{ pi.quantity }}">
                        <td class="td-bold">{{ pi.part.name }} <small style="color:var(--text-muted);">({{ pi.part.make
                                }})</small></td>
                        <td>{{ pi.get_source_display }}</td>
                        <td style="text-align:center;">{{ pi.quantity }}</td>
                        <td>
                            <input type="number" name="used_qty_{{ pi.id }}" class="form-control used-qty" value="0"
                                min="0" max="{{ pi.quantity }}" style="width:80px;" data-id="{{ pi.id }}">
                        </td>
                        <td>
                            <input type="number" name="remaining_qty_{{ pi.id }}" class="form-control remaining-qty"
                                value="{{ pi.quantity }}" readonly style="width:80px;opacity:.6;" data-id="{{ pi.id }}">
                        </td>
                        <td>
                            <input type="number" name="price_{{ pi.id }}" class="form-control part-price" value="0"
                                min="0" step="0.01" style="width:100px;" data-id="{{ pi.id }}">
                        </td>
                        <td style="font-weight:700;color:var(--accent-cyan);text-align:right;">
                            ‚Çπ<span class="line-total" data-id="{{ pi.id }}">0.00</span>
                        </td>
                        <td style="text-align:center;">
                            <label class="form-check" style="margin:0;">
                                <input type="checkbox" name="return_{{ pi.id }}" class="return-check"
                                    data-id="{{ pi.id }}">
                                <span style="font-size:12px;">Return</span>
                            </label>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="6"
                            style="text-align:right;font-weight:700;color:var(--text-primary);font-size:14px;">Total
                            Parts Cost:</td>
                        <td style="font-weight:800;color:var(--accent-cyan);font-size:16px;text-align:right;">‚Çπ<span
                                id="parts-total">0.00</span></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="empty-state" style="padding:24px;">
            <p style="color:var(--text-muted);font-size:13px;">No parts were issued for this complaint.</p>
        </div>
        {% endif %}

        <!-- Charges Section -->
        <div class="section-header mb-2">
            <h3 class="section-title">üí∞ Charges</h3>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="service-charge">Service Charge (‚Çπ)</label>
                <input type="number" id="service-charge" name="service_charge" class="form-control" value="0" min="0"
                    step="0.01" style="font-size:16px;font-weight:600;">
            </div>
            <div class="form-group">
                <label class="form-label">Parts Cost (‚Çπ)</label>
                <div style="font-size:20px;font-weight:700;color:var(--accent-cyan);padding:8px 0;">
                    ‚Çπ<span id="parts-cost-display">0.00</span>
                </div>
            </div>
        </div>

        <!-- Grand Total -->
        <div class="glass-card"
            style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);padding:20px;margin:16px 0;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div
                        style="font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:4px;">
                        Grand Total</div>
                    <div style="font-size:32px;font-weight:900;color:var(--accent-emerald);">
                        ‚Çπ<span id="grand-total-display">0.00</span>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:12px;color:var(--text-muted);">Service: ‚Çπ<span id="svc-summary">0.00</span>
                    </div>
                    <div style="font-size:12px;color:var(--text-muted);">Parts: ‚Çπ<span id="parts-summary">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Special Cases -->
        <div class="form-group">
            <label class="form-label">Special Coverage <small style="color:var(--text-muted);">(select one ‚Äî charges
                    become ‚Çπ0)</small></label>
            <div style="display:flex;gap:24px;flex-wrap:wrap;margin-top:6px;">
                <label class="form-check" style="cursor:pointer;">
                    <input type="checkbox" name="is_free" class="special-case-checkbox" id="is-free">
                    <span style="font-weight:600;">üÜì Free Service</span>
                </label>
                <label class="form-check" style="cursor:pointer;">
                    <input type="checkbox" name="is_amc" class="special-case-checkbox" id="is-amc">
                    <span style="font-weight:600;">üìã AMC</span>
                </label>
                <label class="form-check" style="cursor:pointer;">
                    <input type="checkbox" name="is_warranty" class="special-case-checkbox" id="is-warranty">
                    <span style="font-weight:600;">üõ°Ô∏è Warranty</span>
                </label>
            </div>
        </div>

        <!-- Remarks -->
        <div class="form-group">
            <label class="form-label" for="resolution_remarks">Resolution Remarks</label>
            <textarea name="resolution_remarks" id="resolution_remarks" class="form-control" rows="3"
                placeholder="Describe the work done, parts replaced, and the final outcome..."></textarea>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success btn-lg">‚úì Resolve Complaint</button>
            <a href="{% url 'engineer_complaint_detail' complaint.pk %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('resolve-form');
        const serviceChargeInput = document.getElementById('service-charge');
        const specialCheckboxes = document.querySelectorAll('.special-case-checkbox');
        const partsTotalEl = document.getElementById('parts-total');
        const partsCostDisplay = document.getElementById('parts-cost-display');
        const grandTotalDisplay = document.getElementById('grand-total-display');
        const svcSummary = document.getElementById('svc-summary');
        const partsSummary = document.getElementById('parts-summary');

        function recalcAll() {
            let partsTotal = 0;

            // Calculate each part row
            document.querySelectorAll('.part-row').forEach(row => {
                const issued = parseInt(row.dataset.issued) || 0;
                const usedInput = row.querySelector('.used-qty');
                const remainingInput = row.querySelector('.remaining-qty');
                const priceInput = row.querySelector('.part-price');
                const lineTotalEl = row.querySelector('.line-total');

                const usedQty = parseInt(usedInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;

                // Auto-calc remaining
                const remaining = Math.max(0, issued - usedQty);
                remainingInput.value = remaining;

                // Line total = used * price
                const lineTotal = usedQty * price;
                lineTotalEl.textContent = lineTotal.toFixed(2);

                partsTotal += lineTotal;
            });

            // Update parts totals
            partsTotalEl.textContent = partsTotal.toFixed(2);
            partsCostDisplay.textContent = partsTotal.toFixed(2);
            partsSummary.textContent = partsTotal.toFixed(2);

            // Special case check
            const isSpecial = Array.from(specialCheckboxes).some(cb => cb.checked);

            // Service charge
            let serviceCharge = parseFloat(serviceChargeInput.value) || 0;
            if (isSpecial) {
                serviceCharge = 0;
                serviceChargeInput.value = 0;
                serviceChargeInput.disabled = true;
                serviceChargeInput.style.opacity = '0.5';
            } else {
                serviceChargeInput.disabled = false;
                serviceChargeInput.style.opacity = '1';
            }

            svcSummary.textContent = serviceCharge.toFixed(2);

            // Grand total
            let grandTotal = isSpecial ? 0 : (serviceCharge + partsTotal);
            grandTotalDisplay.textContent = grandTotal.toFixed(2);

            // Color the grand total
            if (isSpecial) {
                grandTotalDisplay.style.color = 'var(--accent-amber)';
            } else {
                grandTotalDisplay.style.color = 'var(--accent-emerald)';
            }
        }

        // Listen for input changes
        form.addEventListener('input', recalcAll);
        form.addEventListener('change', recalcAll);

        // Exclusive checkboxes (only one special case allowed)
        specialCheckboxes.forEach(cb => {
            cb.addEventListener('change', function () {
                if (this.checked) {
                    specialCheckboxes.forEach(other => {
                        if (other !== this) other.checked = false;
                    });
                }
                recalcAll();
            });
        });

        // Re-enable service_charge before submit so it gets sent
        form.addEventListener('submit', function () {
            serviceChargeInput.disabled = false;
        });

        recalcAll();
    });
</script>
{% endblock %}